# ─────────────────────────────────────────────────────────────────────────────
# CI/CD: Build → Push to Azure Container Registry → Deploy to Azure Web App
#
# Trigger: every push to main branch (or manual dispatch)
#
# ACR Pull auth: Managed Identity (no credentials stored/passed)
#   One-time setup already done:
#     az webapp identity assign --name personalised-horoscope --resource-group personalised-rg
#     az role assignment create --assignee <principalId> --role AcrPull --scope <acrId>
#     az resource update ... --set properties.siteConfig.acrUseManagedIdentityCreds=true
#
# Required GitHub Secrets (Settings → Secrets → Actions):
#   AZURE_CREDENTIALS   — JSON from: az ad sp create-for-rbac --sdk-auth
#   ACR_LOGIN_SERVER    — personalisedacr.azurecr.io
#   ACR_USERNAME        — ACR admin username (for docker push only)
#   ACR_PASSWORD        — ACR admin password (for docker push only)
#   AZURE_WEBAPP_NAME   — personalised-horoscope
#   RESOURCE_GROUP      — personalised-rg
#
# Runtime config (REDIS_URL, MONGODB_URI, etc.) lives in App Service
# Application Settings — set once via CLI, never in this file.
# ─────────────────────────────────────────────────────────────────────────────
name: Build & Deploy — Azure Web App

on:
  push:
    branches: [main]
  workflow_dispatch:        # allow one-click manual trigger from GitHub UI

env:
  IMAGE_NAME: horoscope-api

jobs:
  build-and-deploy:
    name: Build, push & deploy
    runs-on: ubuntu-latest

    steps:
      # ── 1. Source ──────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Azure auth ──────────────────────────────────────────────────────
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ── 3. ACR auth (push only — pull uses Managed Identity) ───────────────
      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry:  ${{ secrets.ACR_LOGIN_SERVER }}
          username:  ${{ secrets.ACR_USERNAME }}
          password:  ${{ secrets.ACR_PASSWORD }}

      # ── 4. Build & push ────────────────────────────────────────────────────
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image to ACR
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:cache
          cache-to:   type=registry,ref=${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:cache,mode=max

      # ── 5. Deploy ──────────────────────────────────────────────────────────
      # Updates the linuxFxVersion image tag via Azure CLI.
      # App Service pulls the new image using its Managed Identity (AcrPull role).
      - name: Deploy to Azure Web App
        run: |
          az webapp config container set \
            --name ${{ secrets.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --container-image-name ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          az webapp restart \
            --name ${{ secrets.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ secrets.RESOURCE_GROUP }}

      # ── 6. Verify ──────────────────────────────────────────────────────────
      # Retry every 20s for up to 3 min — container pull + start takes ~60-90s.
      - name: Health check (retry 3 min)
        run: |
          URL="https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/v1/health"
          echo "Polling $URL ..."
          for i in $(seq 1 9); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$URL" || echo "000")
            echo "Attempt $i/9 — HTTP $STATUS"
            if [ "$STATUS" = "200" ]; then
              echo "✓ Deployment successful"
              exit 0
            fi
            sleep 20
          done
          echo "Health check did not return 200 after 3 minutes."
          echo "Run: az webapp log tail --name ${{ secrets.AZURE_WEBAPP_NAME }} --resource-group ${{ secrets.RESOURCE_GROUP }}"
          exit 1
