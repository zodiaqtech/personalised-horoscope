# ─────────────────────────────────────────────────────────────────────────────
# CI/CD: Build → Push to Azure Container Registry → Deploy to Azure Web App
#
# Trigger: every push to main branch (or manual dispatch)
#
# Required GitHub Secrets (Settings → Secrets → Actions → New repository secret):
#
#   AZURE_CREDENTIALS     — JSON output of:
#                             az ad sp create-for-rbac --name "horoscope-deploy" \
#                               --role contributor \
#                               --scopes /subscriptions/<SUB_ID>/resourceGroups/<RG> \
#                               --sdk-auth
#
#   ACR_LOGIN_SERVER      — e.g.  horoscopeacr.azurecr.io
#   ACR_USERNAME          — ACR admin username  (az acr credential show --name horoscopeacr)
#   ACR_PASSWORD          — ACR admin password  (same command)
#   AZURE_WEBAPP_NAME     — App Service name    e.g.  myzodiaq-horoscope
#   RESOURCE_GROUP        — Resource group name e.g.  horoscope-rg
#
# All other runtime config (REDIS_URL, MONGODB_URI, etc.) is stored as
# App Service Application Settings — set once via CLI, never in this file.
# ─────────────────────────────────────────────────────────────────────────────
name: Build & Deploy — Azure Web App

on:
  push:
    branches: [main]
  workflow_dispatch:        # allow one-click manual trigger from GitHub UI

env:
  IMAGE_NAME: horoscope-api

jobs:
  build-and-deploy:
    name: Build, push & deploy
    runs-on: ubuntu-latest

    steps:
      # ── 1. Source ──────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Azure auth ──────────────────────────────────────────────────────
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ── 3. ACR auth ────────────────────────────────────────────────────────
      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry:  ${{ secrets.ACR_LOGIN_SERVER }}
          username:  ${{ secrets.ACR_USERNAME }}
          password:  ${{ secrets.ACR_PASSWORD }}

      # ── 4. Build & push ────────────────────────────────────────────────────
      # Uses registry-based layer cache so repeat builds are fast.
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image to ACR
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:cache
          cache-to:   type=registry,ref=${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:cache,mode=max

      # ── 5. Deploy ──────────────────────────────────────────────────────────
      # Updates the Web App to pull the new image tag.
      # App Service will perform a zero-downtime swap automatically.
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name:  ${{ secrets.AZURE_WEBAPP_NAME }}
          images:    ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      # ── 6. Verify ──────────────────────────────────────────────────────────
      # Azure App Service takes 2-3 min to pull the image and start the container.
      # Retry every 20s for up to 3 minutes before failing.
      - name: Health check (retry 3 min)
        run: |
          URL="https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/v1/health"
          echo "Polling $URL ..."
          for i in $(seq 1 9); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$URL" || echo "000")
            echo "Attempt $i/9 — HTTP $STATUS"
            if [ "$STATUS" = "200" ]; then
              echo "✓ App is healthy"
              exit 0
            fi
            sleep 20
          done
          echo "Health check did not return 200 after 3 minutes."
          echo "Check App Service logs: az webapp log tail --name ${{ secrets.AZURE_WEBAPP_NAME }} --resource-group ${{ secrets.RESOURCE_GROUP }}"
          exit 1
